<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMMM</title>
<!-- branch dev -->

<!-- ===== Required resources -->
<script src="js_lib/jquery-2.2.4.min.js" charset="utf-8"></script>
<script src="js_lib/d3.min.js" charset="utf-8"></script>
<script src="js_lib/vis.js"></script>
<link href="immm.css" rel="stylesheet" type="text/css" />



<script>

//"use strict";  //if strict, a problem with AUTHORISATION   ???

// ===== Global session information =====

var DB_server = {protocol:"http", host:"cctos.sb04.stations.graphenedb.com", port:"24789", user:"cctos", pass:"RbV6dfFdCVnkm4KU2wyb", limit:100};
//var DB_server = {protocol:"http", host:"localhost", port:"7474", user:"cctos", pass:"neopass", limit:"100"};

var defaultNeoRequest = "match (n),(n)-[r]-() return n, r limit 100";
var currentCypherRequest = defaultNeoRequest;
var editScreenLocked = false;
var currentNetworkRequest = "";
var visData = {};


 // ===== Uses JQuery to post an ajax request on Neo4j REST API =====
    
    function restPost(data) {
        var strData = JSON.stringify(data);
        console.log("RestPost: strData = ", strData);       
        return $.ajax({
            type: "POST",
            beforeSend: function (request) {
                if (AUTHORIZATION != undefined) {
                    request.setRequestHeader("Authorization", AUTHORIZATION);
                }
            },
            url: DB_server.protocol + "://" + DB_server.host + ":" + DB_server.port + "/db/data/transaction/commit",
            contentType: "application/json",    // attention to ".value "
            data: strData
        });
    }

// ===== Function to call to display a new graph.

    function callNeoDB(updateCypher) {
        // Create the authorization header for the ajax request. 
        //DB_server.host = hostinput.value;
        var test = updateCypher;        
        AUTHORIZATION = "Basic " + btoa(DB_server.user + ":" + DB_server.pass);
        console.log("AUTHORIZATION = ", AUTHORIZATION);
        // Show loading elements.
        $("#loading").show();
        $("#loadingBar_view").show();
        document.getElementById('text').innerHTML = '0%';
        document.getElementById('bar_div').style.width = '0';
        document.getElementById('loadingBar_view').style.opacity = 1;
        // Post Cypher query to return node and relations and return results as graph.
        restPost({
            "statements": [
                {
                    "statement": updateCypher, 
                    "resultDataContents": ["graph"]
                }
            ]
        }).done(function (data) {
            //console.log("callNeoDB done");
            $("#loading").hide();
            $("#loadingBar_view").hide(); // not working, the loadingBar persist ???

            // Parse results and convert it to vis.js compatible data.
            var graphData = parseGraphResultData(data);
            var nodes = convertNodes(graphData.nodes);
            var edges = convertEdges(graphData.edges);
            visData = {
                nodes: nodes,
                edges: edges
            };
            
            currentNetworkRequest = updateCypher;
            displayVisJsData(visData);
        });
    }

    function displayVisJsData(data) {
        var container = document.getElementById('graph_div');

        var options = {
            interaction: {hover:true},
            nodes: {
                shape: 'ellipse',
                color: '#DDDDFF'
            },
            edges: {
                arrows: 'to'
            },
            groups: {
            	Patient:{
            		shape: 'circle',
            		color: '#CCCCFF'
            	},
            	Patient_group: {
            		shape: 'circle',
            		color: '#BBBBEE'
            	},
            	Observation: {
            		shape: 'box',
            		color: 'yellow'
            	},
            	HealthIssue:{
                   shape: 'ellipse',           	    
            	    color: 'red'
            	},
            	Action:{
            	    shape: 'box',
            	    color: 'green'
            	},
            	
            }
        };

        // initialize the network! with Ids from the VIS point of view
        var network = new vis.Network(container, data, options);
        
        // TEST any event but not effect ???
        network.on("*", function(event, properties, senderId) {
            console.log("TEST any event, event= ", event, "   properties = ", properties);
        });
        

        // temporary view of the content of a node when the mouse fly over this node        
        network.on("hoverNode", function (params) { 
            network.selectNodes([params.node],true);  // ?? 
            var nodeId = params.node;           // problem with nodeId
            //var nodeToShow = data.nodes[nodeId];
            // the filter function called on nodes data will return an array of nodes where node.id === nodeID
            // as there will be in principle only one node, first node of the returned array is returned as nodeToShow
            var nodeToShow = data.nodes.filter(function (node) {return node.id === nodeId;})[0];   
            showNodePopup(nodeToShow);
        });
        
        network.on("blurNode", function (params) { 
            var nodeID = params.node;
            clearViewPopup();
            //TestSelection = network.selection;    //
            //network.selection = [];    // test intended to clear any previous selections
            //params.node = [];
        });
        
 
         // temporary view of the content of an edge when the mouse fly over this edge       
        network.on("hoverEdge", function (params) { 
            network.selectEdges([params.edge],true);  // ?? 
            var edgeId = params.edge;           // problem with edgeId
            //var nodeToShow = data.nodes[nodeId];
            // the filter function called on edges data will return an array of edges where edge.id === edgeID
            // as there will be in principle only one edge, first edge of the returned array is returned as edgeToShow
            var edgeToShow = data.edges.filter(function (edge) {return edge.id === edgeId;})[0];   
            showEdgePopup(edgeToShow);
        });
        
        network.on("blurEdge", function (params) { 
            var nodeID = params.edge;
            clearViewPopup();
            //TestSelection = network.selection;    //
            //network.selection = [];    // test intended to clear any previous selections
            //params.edge = [];
        });
        
        // navigate to nodes in first level relations to the current node        
        network.on("click", function(params){
            var nodeId = parseInt(params.nodes[0]);
            clearViewPopup(); // ??? maybe a problem here since subsequent flyover have no content anymore ???
            if (nodeId) {
                navigate(nodeId);
            };
        });
        
        // Create a persitent node popup, persitent until saved or cancelled, by means of a right mouse click     
        network.on("oncontext", function(params){   // "context" means here the right mouse button
            params.event.preventDefault();
            var nodeId = parseInt(params.nodes[0]);
            var nodeData = data.nodes[nodeId];   // Problem: identification errors after navigation
            //var nodeData = data.nodes.filter(function (node) {return node.id === nodeId;})[0];   
            options.interaction.hover = false;   // ??? no effect
            if (!editScreenLocked){
               editNodePopup(nodeData);
               params.node = [];
            }
        });

        // Create a persitent relation popup, persitent until saved or cancelled, by means of a right mouse click     
        network.on("oncontext", function(params){   // "context" means here the right mouse button
            params.event.preventDefault();
            var edgeId = parseInt(params.edges[0]);
            var edgeData = data.edges[edgeId];   // Problem: identification errors after navigation
            //var nodeData = data.nodes.filter(function (node) {return node.id === nodeId;})[0];   
            options.interaction.hover = false;   // ??? no effect
            if (!editScreenLocked){
               editNodePopup(nodeData);
               params.node = [];
            }
        });
        
        network.once("stabilizationIterationsDone", function () {    // objective ???  the first time ???
            document.getElementById('text').innerHTML = '100%';
            document.getElementById('bar_div').style.width = '496px';
            document.getElementById('loadingBar_view').style.opacity = 0;
            // really clean the dom element
            setTimeout(function () {
                $("#loadingBar_view").hide();
            }, 500);
        });        
        network.on("stabilizationProgress", function (params) {    // objective ???
            var maxWidth = 496;
            //var maxWidth = 800;
            var minWidth = 20;
            var widthFactor = params.iterations / params.total;
            var width = Math.max(minWidth, maxWidth * widthFactor);
            
            document.getElementById('text').innerHTML = Math.round(widthFactor * 100) + '%';
            document.getElementById('bar_div').style.width = width + 'px';

            document.getElementById('text').innerHTML = '100%';
            document.getElementById('bar_div').style.width = '496px';
            document.getElementById('loadingBar_view').style.opacity = 0;
            // really clean the dom element
            setTimeout(function () {        });
            });
    }
     
    function showNodePopup(nodeToShow) {
        popupContainer = document.getElementById('popup_div');
        popupContainer.style.display = "block";   //  ?
        var htm = '<table>';
        for (var key in nodeToShow) {
            htm += '<tr><td><i>' + key + ': </i> </td><td>' + nodeToShow[key] + "</td></tr>";}
        htm += "</table>";
        popupContainer.innerHTML = htm;
    }
    

    function showEdgePopup(edgeToShow) {
        popupContainer = document.getElementById('popup_div');
        popupContainer.style.display = "block";   //  ?
        var htm = '<table>';
        
        for (var key in edgeToShow) {
            htm += '<tr><td><i>' + key + ': </i> </td><td>' + edgeToShow[key] + "</td></tr>";}
        
        htm += "</table>";
        popupContainer.innerHTML = htm;
    }
    
    
    function editNodePopup(nodeData) {
        clearViewPopup();       
        editPopupContainer = document.getElementById('edit_popup_div');
        editPopupContainer.style.display = "block";   //  ?
        editScreenLocked = true;
        var htm = '<h2>Edit Nodes:</h2>';
        htm += "<table>";      
        for (var key in nodeData) {
            htm += "<tr>";
            htm += '<td><i>' + key + ' </i> </td>';
            htm += "<td>";
            //htm += nodeData[key];   // old value well shown, but not editable
            //var field = document.createTextNode(key);
            //document.getElementById(editPopupContainer).appendChild(field);
            //document.getElementById(field).value = nodeData[key];
            //htm += document.getElementById(key).value ;
            
            htm += `<input class='node_data' id=${key}  name=${key} value='${nodeData[key]}' width='500'/>`;
            htm += "</td>";
            htm += "</tr>";
            //htm += nodeData[key] + "<br />";
            //document.getElementById(key).value = nodeData[key];
        };
        htm += "</table>";
        htm += "<br /><button onclick='clearEditPopup()'> Cancel </button>";
        //htm += " --- <button onclick='saveEditedNode(nodeData)'> Save</button>";
        htm += " --- <button onclick='saveEditedNode()'> Save</button>";
        editPopupContainer.innerHTML = htm;
        }        
     
    function editEdgePopup(edgeData) {
        clearViewPopup();       
        editPopupContainer = document.getElementById('edit_popup_div');
        editPopupContainer.style.display = "block";   //  ?
        editScreenLocked = true;
        var htm = '<h2>Edit Relations/h2>';
        htm += "<table>";      
        for (var key in edgeData) {
            htm += "<tr>";
            htm += '<td><i>' + key + ' </i> </td>';
            htm += "<td>";
            htm += `<input class='node_data' id=${key}  name=${key} value='${edgeData[key]}' width='500'/>`;
            htm += "</td>";
            htm += "</tr>";
        };
        htm += "</table>";
        htm += "<br /><button onclick='clearEditPopup()'> Cancel </button>";
        //htm += " --- <button onclick='saveEditedNode(edgeData)'> Save</button>";
        htm += " --- <button onclick=  clearEditPopup  /* 'saveEditedEdge()' */ > Save</button>";
        editPopupContainer.innerHTML = htm;
        }   
             
     function saveEditedNode()  {
     //console.log("saveEditNode")
        var data = document.getElementsByClassName("node_data");  // provide anHTMLCollection, an iterable but with restrictions
                                                                  // no map, no for in
        //var data = map(document.getElementsByClassName("node_data"));
        var currentNodeId = data.id.value;
        var neoRequest = "MATCH (n) WHERE id(n) = " + currentNodeId ;   // node identification from a Neo4j point of view ???
        var i = 1;
        var dataFieldName = "TEST_fieldName";
        var dataValue = "..................";
        var dataArr = Array.from(data);        
        for (i; i < dataArr.length; i++) {
           dataFieldName = dataArr[i].attributes.name.value;  
           dataValue = dataArr[i].value;      
           console.log(" dataValue = ", dataValue.toString());
           //neoRequest += " SET n." + dataFieldName + " = {" + dataValue + "} ";
           neoRequest += " SET n." + dataFieldName + " = " + dataValue ;
        };
        
        neoRequest += ", match (node),()-[r]-() return node,r limit 100";
        alert("neoRequest = " + neoRequest);      
        //callNeoDB(neoRequest);  // will work but a complete reset of the current network should not be necessary !
        clearEditPopup();
        editScreenLocked = false;
        
     }
     
     function clearEditPopup(){
        console.log("clearEditPopup");
        //editPopupContainer.innerHTML = '';
        //options.interaction.hover = true;  // error unkbnown here
        document.getElementById("edit_popup_div").style.display = "none";
        editScreenLocked = false;
    }
   
    function clearViewPopup(){
        //popupContainer.innerHTML = '';
        document.getElementById("popup_div").style.display = "none";
    }

    
    function navigate(nodeId)  {
    	  if (!editScreenLocked) {
    	     console.log("xxxxxx naviguate from nodeId = ", nodeId);
    	     currentNeoRequest = ' match (n)-[r]-(b) where id(n) = ' + nodeId + ' return n, r, b  LIMIT 80';      // ??? How to see also the links between the (b) ?????
		     console.log("currentNeoRequest = ", currentNeoRequest);
		     callNeoDB(currentNeoRequest);  
		     displayVisJsData(visData);
		  }  	  
    }  
    
    function parseGraphResultData(data) {              // called from callNeoDB ..... ?
        var nodes = {}, edges = {};
        data.results[0].data.forEach(function (row) {      // ( ???? error after an update )
            row.graph.nodes.forEach(function (n) {
                if (!nodes.hasOwnProperty(n.id)) {
                    nodes[n.id] = n;                 // creation of a vis.js identification
                }
            });

            row.graph.relationships.forEach(function (r) {
                if (!edges.hasOwnProperty(r.id)) {
                    edges[r.id] = r;
                }
            });
        });

        var nodesArray = [], edgesArray = [];

        for (var p in nodes) {
            if (nodes.hasOwnProperty(p)) {       // properties here ?
                nodesArray.push(nodes[p]);
            }
        }

        for (var q in edges) {
            if (edges.hasOwnProperty(q)) {
                edgesArray.push(edges[q])
            }
        }

        return {nodes: nodesArray, edges: edgesArray};
    }

    function convertNodes(nodes) {       // why a conversion ?
        var convertedNodes = [];

        nodes.forEach(function (node) {
            var nodeLabel = node.labels[0];
            var displayedLabel = nodeLabel + ("\n" + node.properties[Object.keys(node.properties)[0]]).substr(0, 20);
            var authorValue = "unknown";
            var certaintyValue = "unknown";         //node.properties.certainty;
            var importanceValue = "unknown";        //node.properties.importance;
            convertedNodes.push({
                id: node.id,
                author: authorValue,
                label: displayedLabel,
                group: nodeLabel,
                certainty: certaintyValue,
                importance: importanceValue
            })
        });

        return convertedNodes;
    }

    function convertEdges(edges) {
        var convertedEdges = [];
        edges.forEach(function (edge) {
            var authorValue = "unknown";            
            var certaintyValue = "unknown";      //edges.properties.certainty;
            var importanceValue = "unknown";     //edges.properties.importance;
            convertedEdges.push({
                from: edge.startNode,
                to: edge.endNode,
                label: edge.type,
                author: authorValue,
                certainty: certaintyValue,
                importance: importanceValue
            })
        });

        return convertedEdges;
    }

</script>

</head>
<!--<body onload="callNeoDB('match (n),()-[r]-() return n,r limit 100');" style="background-color:#cccccc"> -->
<body onload="callNeoDB(currentCypherRequest);" style="background-color:#cccccc">


<label>
   Test Neo4j request: <input id="dbRequest" type="textarea" size="160" value="">
</label>

<label>
    <button onclick="callNeoDB(dbRequest.value)">GO</button>
    <!--<img id="loading" src="images/ajax-loader.gif">  -->
</label>


<div id="wrapper_view">             
    <div id="graph_div"></div>
    <div id="popup_div">=== test popup_div</div> 
    <div id="edit_popup_div">=== test edit_popup_div </div>
    <div id="loadingBar_view"></div>
    <div class="outerBorder">
            <div id="text">0%</div>
            <div id="border">
                <div id="bar_div"></div>
            </div>
    </div>
</div>


</body>
</html>
